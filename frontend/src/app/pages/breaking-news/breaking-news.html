<!-- src/app/pages/breaking-news/breaking-news.html -->
<div class="p-3">
  <!-- Header -->
  <div class="flex items-center justify-between mb-2">
    <h2 class="text-sm font-semibold">Breaking news</h2>

    <div class="flex items-center gap-2">
      <app-new-content-button
        [itemId]="selectedId()"
        [itemType]="'breaking-news'">
      </app-new-content-button>

      <app-new-video-button
        [itemId]="selectedId()"
        [itemType]="'breaking-news'">
      </app-new-video-button>

      <button
        type="button"
        (click)="openLiveFeedModal(); startLiveFeed()"
        class="text-xs px-2 py-1 rounded-lg bg-sky-700 hover:bg-sky-600 border border-sky-600"
      >
        View live feed
      </button>

      <button
        type="button"
        (click)="loadBreakingNews()"
        class="text-xs px-2 py-1 rounded-lg bg-slate-800 hover:bg-slate-700 border border-slate-700"
      >
        Refresh
      </button>
    </div>
  </div>

  <!-- Main content layout -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
    <!-- Left: list -->
    <div class="lg:col-span-1 rounded-2xl border border-slate-800 bg-slate-900">
      <div class="p-3 border-b border-slate-800">
        <div *ngIf="loading()" class="text-xs text-slate-400">Loading…</div>
        <div *ngIf="error()" class="text-xs text-red-400">{{ error() }}</div>
      </div>

      <div class="max-h-[70vh] overflow-auto">
        <button
          *ngFor="let item of breakingNews(); trackBy: trackById"
          type="button"
          (click)="openBreakingNewsDetail(item.tweetId)"
          class="w-full text-left p-3 border-b border-slate-800 hover:bg-slate-800/40"
          [class.bg-slate-800]="selectedId() === item.tweetId"
        >
          <div class="text-xs text-slate-300 font-medium">
            {{ item.account }}
          </div>
          <div class="text-xs text-slate-200 mt-1 line-clamp-3 whitespace-pre-wrap">
            {{ item.text || '—' }}
          </div>
          <div class="text-[11px] text-slate-500 mt-2">
            {{ item.datetime || '' }}
          </div>
        </button>

        <div *ngIf="!loading() && breakingNews().length === 0" class="p-3 text-xs text-slate-500">
          No breaking news items found.
        </div>
      </div>
    </div>

    <!-- Right: details -->
    <div class="lg:col-span-2 space-y-3">
      <!-- Enrichment -->
      <div class="rounded-2xl border border-slate-800 bg-slate-900 p-3">
        <div class="text-sm font-semibold mb-2">Enrichment</div>

        <div *ngIf="enrichmentLoading()" class="text-xs text-slate-400">Loading enrichment…</div>
        <div *ngIf="enrichmentError()" class="text-xs text-red-400">{{ enrichmentError() }}</div>

        <div *ngIf="!enrichmentLoading() && enrichment() as e" class="text-xs text-slate-200 space-y-2">
          <div *ngIf="e.category"><span class="text-slate-400">Category:</span> {{ e.category }}</div>
          <div *ngIf="e.event_type"><span class="text-slate-400">Event type:</span> {{ e.event_type }}</div>
          <div *ngIf="e.context"><span class="text-slate-400">Context:</span> {{ e.context }}</div>
          <div *ngIf="e.credibility != null"><span class="text-slate-400">Credibility:</span> {{ e.credibility }}</div>
          <div *ngIf="e.confidence != null"><span class="text-slate-400">Confidence:</span> {{ e.confidence }}</div>
          <div *ngIf="e.risk_score != null"><span class="text-slate-400">Risk score:</span> {{ e.risk_score }}</div>

          <div *ngIf="e.entities?.people?.length">
            <span class="text-slate-400">People:</span> {{ e.entities?.people?.join(', ') }}
          </div>
          <div *ngIf="e.entities?.organizations?.length">
            <span class="text-slate-400">Organizations:</span> {{ e.entities?.organizations?.join(', ') }}
          </div>
          <div *ngIf="e.entities?.equipment?.length">
            <span class="text-slate-400">Equipment:</span> {{ e.entities?.equipment?.join(', ') }}
          </div>
        </div>

        <div *ngIf="!enrichmentLoading() && !enrichment() && !enrichmentError()" class="text-xs text-slate-500">
          No enrichment available.
        </div>
      </div>

      <!-- Media -->
      <div class="rounded-2xl border border-slate-800 bg-slate-900 p-3">
        <div class="text-sm font-semibold mb-2">Media</div>

        <div *ngIf="mediaLoading()" class="text-xs text-slate-400">Loading media…</div>
        <div *ngIf="mediaError()" class="text-xs text-red-400">{{ mediaError() }}</div>

        <div *ngIf="!mediaLoading() && media() as m">
          <app-media-embed [links]="m.video_links"></app-media-embed>
        </div>

        <div *ngIf="!mediaLoading() && !media() && !mediaError()" class="text-xs text-slate-500">
          No media available.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Live feed modal -->
<div
  *ngIf="liveModalOpen()"
  class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4"
>
  <div class="w-full max-w-3xl rounded-2xl border border-slate-700 bg-slate-900 p-4 shadow-xl">
    <div class="flex items-start justify-between gap-3">
      <div>
        <h3 class="text-sm font-semibold">Live feed</h3>
        <p class="text-xs text-slate-400 mt-1">
          {{ liveModalMessage() }}
        </p>
        <p *ngIf="liveJobId()" class="text-[11px] text-slate-500 mt-1">
          Job: {{ liveJobId() }}
        </p>
      </div>

      <div class="flex items-center gap-2">
        <button
          type="button"
          class="text-xs px-2 py-1 rounded-lg bg-slate-800 hover:bg-slate-700 border border-slate-700"
          (click)="closeLiveFeedModal()"
        >
          Close
        </button>
      </div>
    </div>

    <div class="mt-4">
      <!-- Spinner / loading indicator -->
      <div
        *ngIf="liveModalStage() === 'starting' || liveModalStage() === 'running'"
        class="flex items-center gap-3 text-xs text-slate-200"
      >
        <span
          class="inline-block h-4 w-4 rounded-full border-2 border-slate-500 border-t-transparent animate-spin"
          aria-hidden="true"
        ></span>
        <span>Working…</span>
      </div>

      <!-- Done -->
      <div *ngIf="liveModalStage() === 'done'" class="text-xs text-emerald-400 mt-2">
        Finished. You can keep browsing results below.
      </div>

      <!-- Error -->
      <div *ngIf="liveModalStage() === 'failed'" class="text-xs text-red-400 mt-2">
        {{ liveError() || 'Something went wrong.' }}
      </div>

      <div *ngIf="liveModalStage() === 'failed'" class="mt-3 flex gap-2">
        <button
          type="button"
          (click)="startLiveFeed()"
          class="text-xs px-2 py-1 rounded-lg bg-sky-700 hover:bg-sky-600 border border-sky-600"
        >
          Retry
        </button>
      </div>

      <!-- Live results list -->
      <div class="mt-4">
        <div class="text-xs text-slate-400 mb-2">
          Results ({{ liveItems().length }})
        </div>

        <div *ngIf="liveItems().length === 0" class="text-xs text-slate-500">
          No live items yet…
        </div>

        <div class="max-h-[420px] overflow-auto space-y-3 pr-1" *ngIf="liveItems().length > 0">
          <div
            *ngFor="let item of liveItems(); trackBy: trackLiveById"
            class="rounded-xl border border-slate-700 bg-slate-950 p-3"
          >
            <div class="flex items-start justify-between gap-3">
              <div class="text-xs text-slate-300">
                <div class="font-semibold">
                  {{ item.authorName || item.author || 'Unknown author' }}
                </div>
                <div class="text-[11px] text-slate-500 mt-0.5">
                  Tweet: {{ item.tweetId }} · Query: {{ item.query || '—' }}
                </div>
              </div>

              <button
                *ngIf="item.searchUrl"
                type="button"
                class="text-[11px] text-sky-400 hover:underline whitespace-nowrap"
                (click)="openExternal(item.searchUrl)"
              >
                Open search
              </button>
            </div>

            <div class="text-xs text-slate-200 mt-2 whitespace-pre-wrap">
              {{ item.text || '—' }}
            </div>

            <div class="mt-2 flex flex-wrap gap-2" *ngIf="item.images?.length">
              <a
                *ngFor="let img of item.images"
                [href]="img"
                target="_blank"
                rel="noreferrer"
                class="block"
              >
                <img
                  [src]="img"
                  alt="image"
                  class="h-16 w-16 object-cover rounded-lg border border-slate-700"
                />
              </a>
            </div>

            <div class="mt-2 text-[11px] text-slate-500 flex flex-wrap gap-x-3 gap-y-1">
              <span *ngIf="item.createdAt">Captured: {{ item.createdAt | date:'medium' }}</span>
              <span *ngIf="item.source">Source: {{ item.source }}</span>
              <span *ngIf="item.enrichmentTweetId">Enrichment: {{ item.enrichmentTweetId }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>
