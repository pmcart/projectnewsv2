<!-- Overlay -->
@if (isOpen()) {
  <div
    class="fixed inset-0 bg-black/50 z-40"
    (click)="onClose()"
  ></div>

  <!-- Drawer -->
  <div class="fixed right-0 top-0 bottom-0 w-96 bg-slate-900 border-l border-slate-700 z-50 shadow-2xl flex flex-col">
    <!-- Header -->
    <div class="bg-slate-800 border-b border-slate-700 p-4 flex items-center justify-between">
      <h2 class="text-lg font-semibold text-white">Version History</h2>
      <button
        (click)="onClose()"
        class="text-slate-400 hover:text-white transition-colors"
        title="Close"
      >
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <!-- Version List -->
    <div class="flex-1 overflow-y-auto p-4">
      @if (versions().length === 0) {
        <div class="text-center py-8 text-slate-400">
          <p>No versions yet</p>
        </div>
      } @else {
        <div class="space-y-3">
          @for (version of versions(); track version.id) {
            <div
              [class.bg-blue-900/30]="isCurrentVersion(version.id)"
              [class.border-blue-500]="isCurrentVersion(version.id)"
              class="bg-slate-800/60 border border-slate-700 rounded-lg p-4 cursor-pointer hover:bg-slate-800 transition-colors"
              (click)="onSelectVersion(version.id)"
            >
              <div class="flex items-start justify-between mb-2">
                <div class="flex items-center gap-2">
                  <span class="text-sm font-semibold text-white">
                    Version {{ version.versionNumber }}
                  </span>
                  @if (isCurrentVersion(version.id)) {
                    <span class="px-2 py-0.5 bg-blue-600 text-white text-xs rounded-full">
                      Current
                    </span>
                  }
                </div>

                @if (version.llmMetadata) {
                  <span class="px-2 py-0.5 bg-purple-900/50 text-purple-300 text-xs rounded">
                    Generated
                  </span>
                }
              </div>

              <div class="space-y-1 text-xs text-slate-400">
                <div class="flex items-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                  </svg>
                  <span>{{ version.createdBy.firstName }} {{ version.createdBy.lastName }}</span>
                </div>

                <div class="flex items-center gap-2">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <span>{{ formatDate(version.createdAt) }}</span>
                </div>

                @if (version.parentVersionId) {
                  <div class="flex items-center gap-2 text-amber-400">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
                    </svg>
                    <span>Revision (after rejection)</span>
                  </div>
                }

                @if (version.llmMetadata) {
                  <div class="mt-2 pt-2 border-t border-slate-700">
                    <div class="text-purple-300">
                      <div>Model: {{ version.llmMetadata.model }}</div>
                      @if (version.llmMetadata.totalTokens) {
                        <div>Tokens: {{ version.llmMetadata.totalTokens }}</div>
                      }
                      @if (version.llmMetadata.duration) {
                        <div>Duration: {{ (version.llmMetadata.duration / 1000).toFixed(1) }}s</div>
                      }
                    </div>
                  </div>
                }
              </div>

              <div class="mt-3 text-xs text-slate-500">
                <div class="truncate">
                  Source: {{ version.sourceType }}
                </div>
              </div>
            </div>
          }
        </div>
      }
    </div>
  </div>
}
